#!/usr/bin/env bash
#
# Bardo - CLI para músicos que querem dominar teoria musical e improvisação
#
# Este script detecta automaticamente o ambiente disponível:
#   1. Se Ruby está instalado, roda diretamente (mais rápido)
#   2. Se não, usa Docker (faz build automático na primeira vez)
#

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
IMAGE_NAME="bardo"

# Se Ruby está disponível e o bardo-cli existe, roda direto
if command -v ruby &>/dev/null && [ -f "$SCRIPT_DIR/bardo-cli" ]; then
    exec ruby "$SCRIPT_DIR/bardo-cli" "$@"

# Senão, tenta Docker
elif command -v docker &>/dev/null; then
    # Build automático na primeira vez
    if ! docker image inspect "$IMAGE_NAME" &>/dev/null 2>&1; then
        echo "Primeira execucao: construindo imagem Docker..."
        echo "Isso pode levar alguns minutos."
        echo ""
        docker build -t "$IMAGE_NAME" "$PROJECT_DIR" || {
            echo ""
            echo "Erro ao construir imagem Docker."
            echo "Verifique se o Docker esta rodando e tente novamente."
            exit 1
        }
        echo ""
        echo "Imagem construida com sucesso!"
        echo ""
    fi

    exec docker run --rm -it "$IMAGE_NAME" "$@"

else
    echo "Bardo: Ruby ou Docker sao necessarios para rodar."
    echo ""
    echo "Opcao 1 - Ruby (>= 3.0):"
    echo "  Instale Ruby e rode:"
    echo "    cd $PROJECT_DIR"
    echo "    bundle install"
    echo "    bin/bardo help"
    echo ""
    echo "Opcao 2 - Docker:"
    echo "  Instale Docker (https://docker.com) e rode:"
    echo "    bin/bardo help"
    echo "  (a imagem sera construida automaticamente)"
    echo ""
    exit 1
fi
